#!/bin/bash
# Will be executed as user "root".

# Replace-Variables
PLUGINNAME=REPLACELBPPLUGINDIR
LBPCONFIGDIR=REPLACELBPCONFIGDIR
LBPHTMLAUTHDIR=REPLACELBPHTMLAUTHDIR
LBPLOGDIR=REPLACELBPLOGDIR

# Source logging library and iniparser
. $LBHOMEDIR/libs/bashlib/loxberry_log.sh
. $LBHOMEDIR/libs/bashlib/iniparser.sh

PACKAGE=$PLUGINNAME
NAME=Daemon
FILENAME=$LBPLOGDIR/daemon.log

LOGSTART "DAEMON Script from Stats4Lox Plugin"

# if [ -x /usr/bin/logger ]; then
    # /usr/bin/logger "loxberry-plugin-$pluginname - DAEMON Script from Stats4Lox Plugin"
# fi

# Use correct rrdcached settings
if [ ! -L /etc/default/rrdcached ]; then
  mv /etc/default/rrdcached /etc/default/rrdcached.old
  ln -s $LBPCONFIGDIR/rrdcached /etc/default/rrdcached
  /usr/sbin/service rrdcached restart
fi

# Grafana Integration
iniparser $LBPCONFIGDIR/stats4lox.cfg "GRAFANA"
GRAFANAenablerrdserver="${GRAFANAenablerrdserver^^}"
LOGINF "Grafana Integration enabled: $GRAFANAenablerrdserver"
if [ "$GRAFANAenablerrdserver" == "TRUE" ] || [ "$GRAFANAenablerrdserver" == "1" ] ; then
	LOGINF "Starting Grafana Integration on port GRAFANArrdserverport"
	$LBPHTMLAUTHDIR/ajax/ajax-settings.cgi action=start key=GRAFANA.enablerrdserver
fi


# Finished
exit 0
